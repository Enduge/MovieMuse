{% extends "layout.html" %}
{% load static %}
{% block title %}
{% endblock %}

{% block head %}
<link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}">
{% endblock %}

{% block content %}
    <h1>Randomly Selected Movie</h1>
    <div id="loading">Fetching a random movie...</div>
    <div id="result"></div>

    <script>
        const tmdbApiKey = '9069e9679489f7393d82ea5f5af0e201'; // Replace with your actual TMDb API key
        const omdbApiKey = '1e9287fc'; // Your OMDb API key
        const genre = "{{ request.GET.genre }}";
        const rating = "{{ request.GET.rating }}";
        const director = "{{ request.GET.director }}";
        const yearFrom = "{{ request.GET.yearFrom }}";
        const yearTo = "{{ request.GET.yearTo }}";
        const resultDiv = document.getElementById('result');
        const loadingDiv = document.getElementById('loading');

        async function fetchMovieDetailsFromOMDb(title) {
            const url = `https://www.omdbapi.com/?apikey=${omdbApiKey}&t=${encodeURIComponent(title)}`;
            const response = await fetch(url);
            return response.json();
        }

        async function fetchContentRating(movieId) {
            const url = `https://api.themoviedb.org/3/movie/${movieId}/release_dates?api_key=${tmdbApiKey}`;
            const response = await fetch(url);
            const data = await response.json();
            if (data.results) {
                const usRelease = data.results.find(release => release.iso_3166_1 === 'US');
                if (usRelease) {
                    return usRelease.release_dates[0].certification;
                }
            }
            return null;
        }

        async function fetchRandomMovieFromTMDb() {
            loadingDiv.style.display = 'block';
            resultDiv.innerHTML = '';

            try {
                console.log('Fetching movies from TMDb...');

                // Randomize the sorting order
                const sortOptions = ['popularity.desc', 'vote_average.desc', 'release_date.desc', 'revenue.desc', 'original_title.asc'];
                const randomSort = sortOptions[Math.floor(Math.random() * sortOptions.length)];

                // Randomize the starting page (between 1 and 10)
                const randomStartPage = Math.floor(Math.random() * 10) + 1;
                let page = randomStartPage;
                let allMovies = [];

                while (allMovies.length < 50) { // Fetch up to 50 movies
                    let tmdbUrl = `https://api.themoviedb.org/3/discover/movie?api_key=${tmdbApiKey}&language=en-US&sort_by=${randomSort}&page=${page}`;

                    if (genre) {
                        const genreId = await getGenreId(genre);
                        if (genreId) tmdbUrl += `&with_genres=${genreId}`;
                    }

                    if (yearFrom) tmdbUrl += `&primary_release_date.gte=${yearFrom}-01-01`;
                    if (yearTo) tmdbUrl += `&primary_release_date.lte=${yearTo}-12-31`;

                    console.log(`Fetching page ${page} with sort order ${randomSort}: ${tmdbUrl}`);
                    loadingDiv.textContent = `Fetching page ${page}...`;
                    const response = await fetch(tmdbUrl);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                    const data = await response.json();
                    console.log('TMDb API response:', data);

                    if (data.results.length === 0) break;

                    allMovies = allMovies.concat(data.results);
                    page++;

                    // Add a delay between requests to avoid rate limits (change number to speed up/slow down)
                    await new Promise(resolve => setTimeout(resolve, 200));
                }

                if (allMovies.length === 0) {
                    console.log('No movies found matching the criteria.');
                    resultDiv.innerHTML = `<div class="error">No movies matched your criteria</div>`;
                    return;
                }

                console.log('Filtering movies by director and rating...');
                const filteredMovies = [];
                for (const movie of allMovies) {
                    // Fetch movie credits to get the director
                    const creditsUrl = `https://api.themoviedb.org/3/movie/${movie.id}/credits?api_key=${tmdbApiKey}`;
                    const creditsResponse = await fetch(creditsUrl);
                    const creditsData = await creditsResponse.json();

                    // Check if any director matches the user's input
                    const directors = creditsData.crew.filter(person => person.job === 'Director');
                    const directorMatch = directors.some(person =>
                        person.name.toLowerCase().includes(director.toLowerCase())
                    );

                    if (director && !directorMatch) continue; // Skip if director doesn't match

                    // Fetch content rating
                    const contentRating = await fetchContentRating(movie.id);
                    console.log(`Movie: ${movie.title}, Rating: ${contentRating}`);
                    if (rating && contentRating !== rating) continue; // Skip if rating doesn't match

                    filteredMovies.push(movie);
                }

                if (filteredMovies.length === 0) {
                    console.log('No movies matched the director or rating filter.');
                    resultDiv.innerHTML = `<div class="error">No movies matched your criteria</div>`;
                    return;
                }

                console.log('Randomly selecting a movie...');
                const randomMovie = filteredMovies[Math.floor(Math.random() * filteredMovies.length)];
                console.log('Selected movie:', randomMovie.title);

                console.log('Fetching details from OMDb...');
                const movieDetails = await fetchMovieDetailsFromOMDb(randomMovie.title);
                console.log('OMDb API response:', movieDetails);

                if (movieDetails.Response === 'False') {
                    console.log('Error fetching movie details from OMDb.');
                    resultDiv.innerHTML = `<div class="error">Error fetching movie details</div>`;
                    return;
                }

                console.log('Displaying movie card...');
                const posterUrl = movieDetails.Poster !== 'N/A' ? movieDetails.Poster : `https://image.tmdb.org/t/p/w500${randomMovie.poster_path}`;
                resultDiv.innerHTML = `
                    <div class="watchparty-movie-card">
                        <img src="${posterUrl}" alt="${movieDetails.Title} Poster">
                        <div class="watchparty-movie-info">
                            <div class="watchparty-movie-title">${movieDetails.Title}</div>
                            <div class="watchparty-movie-year">${movieDetails.Year}</div>
                            <div>Genre: ${movieDetails.Genre}</div>
                            <div>Rated: ${movieDetails.Rated}</div>
                            <div>Director: ${movieDetails.Director}</div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error fetching movie:', error);
                resultDiv.innerHTML = `<div class="error">Error fetching movie data. Please try again.</div>`;
            } finally {
                loadingDiv.style.display = 'none';
            }
        }

        async function getGenreId(genreName) {
            // Map genre names to TMDb genre IDs
            const genreMap = {
                'Action': 28,
                'Adventure': 12,
                'Animation': 16,
                'Comedy': 35,
                'Crime': 80,
                'Documentary': 99,
                'Drama': 18,
                'Family': 10751,
                'Fantasy': 14,
                'History': 36,
                'Horror': 27,
                'Music': 10402,
                'Mystery': 9648,
                'Romance': 10749,
                'Science Fiction': 878,
                'Thriller': 53,
                'War': 10752,
                'Western': 37,
            };
            return genreMap[genreName] || null;
        }

        fetchRandomMovieFromTMDb();
    </script>
{% endblock %}
